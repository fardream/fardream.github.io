---
layout: post
title:  "Portfolio Optimization Part 2: Risk Term"
date:   2021-04-27 15:43:00 -0400
categories: portfolio optimization
---

## Structured Risk Model

For equities, the covariance matrix is generally structured as factor model. There are vendors of those models (BARRA, Axioma, etc), people also build them own, or a mixture of the two.

$$\begin{align}
\mathbf{\Sigma} = \mathbf{\Sigma}_I + \mathbf{F}\mathbf{\Sigma}_F\mathbf{F}^T
\end{align}$$

$$\mathbf{\Sigma}_I$$ is **idiosyncratic variance** or **idiosyncratic risk**, which is a diagonal matrix with all non-negative terms. Its row and column counts are number of stocks in the risk model.

$$\mathbf{\Sigma}_F$$ is **factor variance** or **factor variance**, which is a symmetric positive semi definite matrix. Its row and column counts are the number of factors in the risk model. There could be many types of factors. Momentum is an example of style factor, and Information Technology is an example of industry factor. The definitions of those are vendor dependent, and many will come up with their own factors.

$$\mathbf{F}$$ is **factor loadings**. Its row count is the number of stocks in the risk model, and its column count is the number of factors. Each row is the factor loading of a single stock, and each column is the loadings for all stocks of a single factor. Dollar amount of holding multiplied by factor loading is called factor exposure, or

$$\begin{align}
\mathbf{f}=\mathbf{F}^T\mathbf{w}
\end{align}$$

The risk model is so structured that covariance between different stocks is only through the factor.

The risk model greatly reduces the number of covariances that needs to be estimated. For example, RUSSELL 3000 stock will contain 4.5 million variances or covariances to estimate, whereas a 100 factor model only needs 3000 idiosyncratic variance and 50100 factor variance/covaraince to estimate. Reducing number of covariances also helps improve the performance of the optimization.

## Different Stock Classes and Index

The assumption that $$\mathbf{\Sigma}_I$$ is diagonal will quickly run into problem if we consider names such as **GOOG** and **GOOGL**. The returns of the two stocks are highly correlated, and in many risk models they are considered the same.

Another difficulty arises when there are index futures or ETF in the portfolio, for example, beta hedge may be done through trading SP 500 futures. Although it can be added to the risk models factor loading and idiosyncratic risk matrices, the idiosyncractic return of SP 500 is a linear combination of returns of its components and therefore its return should have correlations with its components even in idiosyncratic space.

## Transformation Matrix

Both of those cases can be handled by introducing a linear transformation from real holding into a holding that have unique stocks - let's call this risk space. For example, we can choose GOOGL to be the stock in risk space and holdings in both GOOG and GOOGL will be added together:

$$\begin{align}
w^*_{\text{GOOGL}}=\begin{pmatrix} 1 & 1\end{pmatrix} \begin{pmatrix} w_{\text{GOOGL}} \\ w_{\text{GOOG}} \end{pmatrix}
\end{align}$$

where $$w^*$$ is the holding in risk space and $$w$$ is the real holding.

Similarly, the holding in index futures or ETFs can be transformed into its components

$$\begin{align}
w^*_i=\begin{pmatrix} c_0 \\ \vdots \\ c_i \\ c_n \end{pmatrix} w
\end{align}$$

where $$w^*_i$$ is the holding in risk space for component $$i$$, and $$c_i$$ is the dollar weight of the component $$i$$ for the index. $$w$$ is the holding for the index future or ETF.

Putting those two types of transformation together, a transformation matrix can be constructed by:

1. Generate a unique stock universe for risk space.
2. Use $$1$$s for stocks that are considered the same in risk space. Use component weights for index futures and ETFs

To sum up, we are creating a transformation matrix $$\mathbf{T}$$ where

$$\begin{align}
\mathbf{w}^*=\mathbf{T}\mathbf{w}
\end{align}$$

And all the risk models are for $$\mathbf{w}^*$$ instead.

There are some cases that differentiating between cointegrated stocks is actually required - for example, arbitrage between a foreign stock and its corresponding ADR. This can be handled by treat one of them as an index of the other plus a fake stock, which models the difference. Of course, there are scenarios that those simplification doesn't work.


## Other Return Related Terms/Alpha

It should be noted that risk here is related to the returns of the stocks, and therefore the above mentioned transformation should also apply to all the terms that are related to returns, such as alpha terms. That means the alpha input should also be in **the same risk space** instead of the real holdings. This may seem conter-intuitive since alpha is linear. This will prevent two types of errors:

- We have assumed different classes of the same stock have the same risk, which also means same return. Therefore we prevent the arbitrage between different classes of the same stock,
- This prevent arbitrage between index and its component stocks. This will also help numerically. Optimizer may see the alpha or return difference between the index and the value from its component returns as an arbitrage opportunity, which may simply rise from floating point operations (and/or market microstructure such as bid ask spread).

## Unique solution

With transformation matrix $$\mathbf{T}$$, the covariance matrix in the real holding space will be

$$\begin{align}
\mathbf{\Sigma} = \mathbf{T}^T\left(\mathbf{\Sigma}_I + \mathbf{F}\mathbf{\Sigma}_F\mathbf{F}^T\right)\mathbf{T}
\end{align}$$

Here is the problem, it may not be invertible (still positive semi definite). This is quite understandable. For example, if both GOOG and GOOGL are in very simple mean variance optimization, the optimizer will **only** be able to find a unique solution for the sum of GOOG and GOOGL. There may be cases where a huge position in GOOG is offset by another huge position in GOOGL. The solution of course is mathematically sound, we still don't want it. There are several ways to get around or avoid this situation

- Filter the universe before hand - make sure only one of the different classes of stocks is chosen.
- Add a small quadratic sizing penalty to the holdings, a.k.a just like adding a small positive diagonal matrix to the covariance matrix in holding space. (but don't do it this way though because it will be extremely confusing, Just add another rotated cone to the objective function)
- For indices, add some other constraints, such as beta neutral. There may also be the case that the very reason that an index future or an ETF is added to the portfolio is to add some constraint such as beta neutral, controlling factor risk, etc.

## Risk Term

Now the risk term is slightly more complex

$$\begin{align}
x_\sigma = x_I + x_f \\
\mathbf{w}^* =\mathbf{T}\mathbf{w} \\
\mathbf{l}_I = \mathbf{\Lambda} \mathbf{w}^* \\
\mathcal{Q}_r\left(1/2,x_I,\mathbf{l}_I\right) \\
\mathbf{f} = \mathbf{F}\mathbf{w}^* \\
\mathbf{l}_f = \mathbf{L}_F^T\mathbf{f} \\
\mathcal{Q}_r\left(1/2,x_f,\mathbf{l}_f\right)
\end{align}$$

where $$\mathbf{\Sigma}_I=\mathbf{\Lambda}\mathbf{\Lambda}$$ and $$\mathbf{\Sigma}_F=\mathbf{L}_F\mathbf{L}_F^T$$.

The intermediate variables $$\mathbf{w}^*$$ (holdings in risk space) and $$\mathbf{f}$$ (factor exposures) can be omitted, but adding them will improve clarity and help debugging.

## More on transformation matrix

It may save time by storing the transformation matrix. It can be computed by knowing **only** the universe of the stocks and the index weights. It also help if many calculations of factor exposures or other risk metrics are needed either for analysis or reporting purposes.

The matrix itself is sparse, and its construction lends nicely to the Compress Sparse Row format, and can utilize the linear algebra library BLAS.

## Condition number of covariance matrix

One last thing to keep an eye on is the condition number of the covariance matrix. There may be cases where several assets are highly correlated either by coincidence or by design. The handling should be similar with aforementioned handling of singular covariance matrix.